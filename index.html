<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <!-- import CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
  <title>Kindle to Flomo</title>
  <style>
    body {
      background-color: #FAFAFA;
    }

    .el-divider__text {
      background-color: #FAFAFA;
    }

    .el-tag {
      padding: 0 4px;
      line-height: 24px;
      height: 24px;
      margin-bottom: 3px
    }

    #app {
      display: flex;
      justify-content: center;
    }

    .aside {
      max-width: 360px;
      margin: 20px;
    }

    .main {
      margin: 20px;
      max-width: 600px;
    }

    .el-upload-list__item-name [class^=el-icon] {
      height: auto
    }

    .help ul {
      margin-top: 20px;
      padding: 0;
    }

    .main p {
      line-height: 1.8;
      margin: 0;
      min-height: 20px;
    }

    .main .main-header {
      display: block;
      margin-bottom: 15px;
      padding: 0 10px;
      font-size: 1em;
      font-weight: bold;
    }

    .main .el-card {
      margin-bottom: 10px;
      font-size: 14px;
      color: #606266
    }

    .main .el-card .el-card__body {
      padding: 15px;
    }

    .selected {
      border: 1px solid #5783F7;
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="aside">
      <h1 style="color: #606266">kindle2flomo</h1>
      <el-upload class="upload-demo" drag action="#" :multiple="true" :file-list="fileList" :http-request="handleRequest" :on-preview="preview" :before-remove="beforeRemove"
        :on-change="uploadChange" :on-success="uploadSuccess" :on-exceed="exceed" :limit="10000" accept=".csv, .html">
        <i class="el-icon-upload"></i>
        <div class="el-upload__text">将 CSV 或 HTML 文件拖到此处，帮你解析</div>
        <div class="el-upload__tip" slot="tip">支持一次上传 10000 本书的笔记，就怕你没有</div>
      </el-upload>

      <div v-if="show" class="form">
        <el-divider><i class="el-icon-upload" style="color: #909399"> 导入 FLOMO</i></el-divider>
        <el-form :model="form" :rules="rule" ref="form" label-position="top" label-width="100px" class="demo-ruleForm">
          <el-form-item label="Flomo 专属 API（静态页面，不保存信息）" prop="api">
            <el-input v-model="form.api" placeholder="https://flomoapp.com/iwh/xxxxxxxxx"></el-input>
          </el-form-item>
          <el-form-item label="自定义分隔符（标注与笔记之间）" prop="delimiter">
            <el-input v-model="form.delimiter" placeholder="默认空一行"></el-input>
          </el-form-item>
          <el-form-item label="是否顺序查看笔记" prop="is_order">
            <el-switch v-model="form.is_order" active-text="顺序" inactive-text="随机" change="switchChange"></el-switch>
            <!-- <span style="color: #606266">* 选择顺序查看，插入时间较长，平均每秒1条</span> -->
            <el-popover placement="top-start" title="" width="200" trigger="hover"
              content="实现在flomo上顺序查看，需倒序插入笔记，每条笔记插入时间相隔 1s">
              <i style="color: #606266" class="el-icon-question" slot="reference"></i>
            </el-popover>
          </el-form-item>
          <el-form-item>
            <el-button type="danger" :disabled="form.is_disabled" :loading="form.is_loading" @click="post('form')">导入
              Flomo</el-button>
            <!-- <el-link type="primary" href="javascript:location.reload();"> 换本书导入</el-link> -->
          </el-form-item>
        </el-form>
        <el-alert v-if="showUploadMessage" title="导入成功" type="success" :description="uploadMessage" show-icon>
        </el-alert>
      </div>
      <div class="help">
        <el-divider><i class="el-icon-question" style="color: #909399"> 帮助</i></el-divider>
        <ul style="list-style: none;">
          <li>
            <el-link type="info"
              href="https://mp.weixin.qq.com/s?__biz=MjM5MDQ4NjUwMg==&mid=2649198191&idx=1&sn=95c506dde4a079d2840a91b12ca358a8&chksm=be5734e68920bdf04af5ad5f31d8c40acea17e723b1b0eeaa2d3d47d009a0adc5abca44bc953&token=1351484622&lang=zh_CN#rd"
              target="_blank">1. 怎么获取笔记文件？</el-link>
          </li>
          <li>
            <el-link type="info"
              href="https://mp.weixin.qq.com/s?__biz=MjM5MDQ4NjUwMg==&mid=2649198220&idx=1&sn=5d0fecf4d3a4ab1469724292dad9797d&chksm=be5734058920bd13ac17f149d7a54dd01b17a066d70f55a813ebb338075b6837f6c6605b255b&token=1351484622&lang=zh_CN#rd"
              target="_blank">2. 想了解它诞生的故事？</el-link>
          </li>
          <li>
            <el-link type="info"
              href="https://mp.weixin.qq.com/s?__biz=MjM5MDQ4NjUwMg==&mid=2649198238&idx=1&sn=31d5111d4a3bdc65ab1283612f1427f1&chksm=be5734178920bd0117a068f2c73897fd05c37bddba78efd62ccdf2bb6df5a0386172a4499143&token=677060446&lang=zh_CN#rd"
              target="_blank">3. 想了解它的实现过程？</el-link>
          </li>
        </ul>
      </div>
    </div>
    <div v-if="result.length" class="main">
      <h2 style="color: #606266">《{{ book_title }}》</h2>
      <div class="main-header" style="color: #606266">
        <span>共 {{ result.length }} 条笔记，已选 {{ count }} 条</span>
        <el-popover placement="top-start" title="" width="250" trigger="hover" content="Flomo 每天只支持上传 100 条 Memo">
          <i style="color: #606266" class="el-icon-question" slot="reference"></i>
        </el-popover>
        <div class="op" style="float: right;">
          <el-link type="primary" @click.native="selectAllCard">全选</el-link>
          <el-link type="primary" @click.native="cancelselectAllCard">全不选</el-link>
        </div>
      </div>
      <div v-for="(item,index) in result" :key="index">
        <el-card shadow="hover" @click.native="clickCard(index)" :class="{ selected: item.selected }">
          <el-tag>{{ item.tags }}</el-tag>
          <p>{{ item.highlight }}</p>
          <div v-if="item.note">
            <p>{{ form.delimiter }}</p>
            <p type="info">笔记：{{ item.note }}</p>
          </div>
        </el-card>
      </div>
    </div>
  </div>
</body>
<!-- import Vue before Element -->
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<!-- import JavaScript -->
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<!-- axios -->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
  // let url = 'http://kindle2flomo.90byte.com'
  let url = 'http://127.0.0.1:5000'
  let app = new Vue({
    el: '#app',
    data: {
      fileList: [],
      form: {
        delimiter: '',
        api: '',
        is_order: false,
        is_disabled: false,
        is_loading: false,
        is_selected: false
      },
      rule: {
        delimiter: [
          { min: 1, max: 30, message: '长度在 1 到 30 个字符', trigger: 'blur' }
        ],
        api: [
          { required: true, message: '请填写 Flomo 的 API 信息', trigger: 'blur' }
        ],
        is_order: false
      },
      book_title: '',
      result: [],
      count: 0,
      show: false,
      showUploadMessage: false
    },
    methods: {
      clickCard(index) {
        memo_arr = this.result
        the_memo = memo_arr[index]
        the_memo.selected = !the_memo.selected
        memo_arr.splice(index, 1, the_memo)
        this.result = memo_arr
        if(the_memo.selected){
          this.count ++;
        }else{
          this.count --;
        }
      },
      selectAllCard() {
        memo_arr = this.result
        memo_arr_new = []
        for (var i = 0; i < memo_arr.length; i++) {
          memo_arr[i].selected = true
          memo_arr_new.push(memo_arr[i])
        }
        this.result = memo_arr_new
        this.count = memo_arr_new.length;
      },
      cancelselectAllCard() {
        memo_arr = this.result
        memo_arr_new = []
        for (var i = 0; i < memo_arr.length; i++) {
          memo_arr[i].selected = false
          memo_arr_new.push(memo_arr[i])
        }
        this.result = memo_arr_new;
        this.count = 0;
      },
      preview(file) {
        this.count = 0
        this.parse(file)
      },
      uploadSuccess(res, file, fileList){
        console.log('success')
        // this.form.file = fileList[0].raw;
      },
      uploadChange(file, fileList) {
        this.fileList.push(file.raw)
      },
      exceed() {
        this.$message.error('一次只支持上传 10000 个文件');
      },
      beforeRemove(){
        this.$message.error('一万本还不够吗')
        return false
      },
      handleRequest(){
        var length = this.fileList.length;
        if(length == 1){
          this.parse(this.fileList[0])
        }
      },
      parse(file) {
        if (file) {
          let formData = new FormData();
          formData.append("file", file);
          axios.post(url + '/parse', formData, {
            "Content-Type": "multipart/form-data"
          })
            .then(response => {
              this.book_title = response.data.book_title
              this.result = response.data.result
              this.show = true
            })
            .catch(error => {
              console.log(error);
            });
        } else {
          this.$message.error('请上传Kindle笔记文件');
        }
      },
      post(formName) {
        this.$refs[formName].validate((valid) => {
          if (valid) {
            if (this.result.length > 100) {
              return this.$message.error('Flomo API 每天只支持 100 条');
            }
            var data = [];
            for(var i = 0 ; i < this.result.length; i++){
              if(this.result[i].selected){
                data.push(this.result[i])
              }
            }
            let formData = new FormData();
            formData.append("api", this.form.api);
            formData.append("delimiter", this.form.delimiter);
            formData.append("is_order", this.form.is_order);
            formData.append("data", JSON.stringify(data));
            this.form.is_loading = true;
            axios.post(url + '/post', formData, {
              "Content-Type": "multipart/form-data"
            })
              .then(response => {
                console.log(response);
                this.uploadMessage = response.data.message
                this.form.is_disabled = true
                this.form.is_loading = false
                this.showUploadMessage = true
              })
              .catch(error => {
                console.log(error);
              });
          } else {
            return false;
          }
        });
      }
    }
  })
</script>

</html>